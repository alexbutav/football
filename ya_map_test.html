<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <script src="https://api-maps.yandex.ru/2.1/?apikey=eb7b7344-1b0d-430d-b9d2-211ffbda9429&lang=ru_RU"
                type="text/javascript"></script>
        <script src="https://yastatic.net/s3/mapsapi-jslibs/area/0.0.1/util.calculateArea.min.js" type="text/javascript"></script>
        <script>

            var _fields = [];

            var vertices = [
                [55.80666815438335, 37.75769110885906],
                [55.80694912038786, 37.758887374079684],
                [55.80667419668443, 37.759128772891025],
                [55.806353953428605, 37.75795396534251]
            ];

            // API готовы
            ymaps.ready(['util.calculateArea']).then(function () {

                var placemark;

                window.map = new ymaps.Map('map', {
                        // center: result.geoObjects.position,
                        center: [55.806616794792376, 37.75859769550608],
                        zoom: 16
                    });
                    
                    // устанавливаем курсор стрелкой
                    map.cursors.push('arrow');

                    // тут мы должны загрузить все
                    // существующие коробки



                    // события при клике
                    map.events.add('click', function (e) {
                        return;
                        
                        // Получение координат щелчка
                        let coords = e.get('coords');
                        console.log(coords);

                        // прежде чем перемещать метку
                        // необходимо определить не конфликтует ли она с другими

                        // для этого с помощью API выбираем все метки в радиусе
                        // и смотрим расстояние до них
                        // если меньше какой-нибудь min_delta
                        // то не разрешаем ставить метку, т.к. уже есть

                        // ymaps.coordSystem.geo.getDistance(p1, p2);
                        // возвращает расстояние между точками в метрах

                        // перемещение  метки
                        if(placemark === undefined) {
                            placemark = new ymaps.Placemark(coords);
                            map.geoObjects.add( placemark );
                        } else {
                            placemark.geometry.setCoordinates(coords);
                        }

                        // добавляем случайные метки вокруг
                        for(let i = 0; i < 7; i++) {
                            let newX = coords[0] - 0.005 + 0.01*Math.random();
                            let newY = coords[1] - 0.005 + 0.01*Math.random();
                            map.geoObjects.add( new ymaps.Placemark([newX, newY]) );
                        }
                    });

                    let p = new ymaps.Polygon([vertices], {}, {
                        // Цвет заливки.
                        fillColor: 'rgba(46, 204, 64, 0.5)',
                        // Цвет обводки.
                        strokeColor: '#111111',
                        // Ширина обводки.
                        strokeWidth: 2,
                        draggable: true
                    });

                    map.geoObjects.add(p);
                    _fields.push(p);

                    
                    // let coordinates = p.geometry.getCoordinates()[0];
                    // console.log(coordinates.length);
                    // for(let i = 0; i < coordinates.length - 1; i++) {
                    //     console.log(i);
                    //     let p1 = coordinates[i];
                    //     let p2 = coordinates[i + 1];
                    //     console.log(`сторона ${i + 1}`, ymaps.coordSystem.geo.getDistance(p1, p2));
                    // }

                // определяем геопозицию клиента
                if(localStorage.getItem("geolocation")) {
                    window.geolocation = JSON.parse(localStorage.getItem("geolocation"));
                    console.log("geolocation", geolocation);
                } else {
                    ymaps.geolocation.get()
                    .then((result) => {
                        console.log(result);
                        localStorage.setItem("geolocation", JSON.stringify(result.geoObjects.position));
                    })
                    .catch((err) => console.log(err));
                }
            });

            function addField() {
                // Создаем многоугольник без вершин.
                let myPolygon = new ymaps.Polygon([], {}, {
                    // Курсор в режиме добавления новых вершин.
                    editorDrawingCursor: "crosshair",
                    // Максимально допустимое количество вершин.
                    editorMaxPoints: 5,
                    fillImageHref: 'rubber.png',
                    // Тип заливки фоном.
                    fillMethod: 'tile',
                    opacity: 0.5,
                    // Цвет заливки.
                    // fillColor: 'rgba(46, 204, 64, 0.5)',
                    // Цвет обводки.
                    strokeColor: '#111111',
                    // Ширина обводки.
                    strokeWidth: 2,
                    draggable: true
                });

                myPolygon.events.add("geometrychange", (e) => {
                    setTimeout(function() {
                        let target = e.get("target");
                        // если количество координат больше 1ух
                        if( target.geometry.getCoordinates()[0].length > 1 ) {
                            try {
                                let geoQueryResult = ymaps.geoQuery(_fields);
                                let intersected = geoQueryResult.searchIntersect(target);
                                if(intersected.getLength()) {
                                    target.options.set("fillColor", "rgba(255, 65, 54, 0.5)");
                                } else {
                                    let area = Math.round(ymaps.util.calculateArea(target));
                                    if(area > 12000) {
                                        console.log("Area", area);
                                        target.options.set("fillColor", "rgba(255, 65, 54, 0.5)");
                                    } else if(area < 100) {
                                        console.log("Area", area);
                                        target.options.set("fillColor", "rgba(255, 65, 54, 0.5)");
                                    } else {
                                        target.options.set("fillColor", "rgba(46, 204, 64, 0.5)");
                                    }
                                }
                            } catch(err) {
                                console.log(err);
                            }
                        }

                    });
                });

                // Добавляем многоугольник на карту.
                map.geoObjects.add(myPolygon);

                // добавляем многоугольник в коллекцию
                //_fields.push(myPolygon);

                // Включаем режим редактирования с возможностью добавления новых вершин.
                myPolygon.editor.startDrawing();
            }

            //map.geoObjects.add( new ymaps.Placemark([55.684758, 37.738521]) );
        </script>
    </head>
    <body>
        <style>
            #map { cursor: default; }
        </style>
        <div id="map" style="width: 500px; height: 500px;"><div>
        <button onclick='addField()'>Добавить поле</button>
    </body>
</html